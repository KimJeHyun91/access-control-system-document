openapi: 3.0.3
info:
  title: Device Service API
  description: |
    장비 관리 서비스 API 명세서입니다.<br>
    ACU, 리더기, 컨트롤러, 카메라 등 물리적 보안 장비의 수명 주기와 설정을 관리합니다.
  version: 1.0.0
  contact:
    name: "Jehyun Kim"

servers:
  - url: http://localhost:4300/api/v1/device
    description: "로컬 개발 서버"

tags:
  - name: 1. Device Management
    description: 장비 CRUD 및 조회
  - name: 2. Firmware Management
    description: 장비 펌웨어 파일 및 버전 관리

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    BadRequest:
      description: "잘못된 요청"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: "인증 실패"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: "권한 없음"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: "리소스를 찾을 수 없음"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Conflict:
      description: "데이터 충돌 (중복 등)"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    InternalServerError:
      description: "서버 내부 오류"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    PageMetadata:
      type: "object"
      properties:
        size:
          type: "integer"
          description: "페이지 당 항목 수"
          example: 20
        page:
          type: "integer"
          description: "현재 페이지 번호 (0부터 시작)"
          example: 0
        totalElements:
          type: "integer"
          description: "전체 항목 수"
          example: 100
        totalPages:
          type: "integer"
          description: "전체 페이지 수"
          example: 5
        isLast:
          type: "boolean"
          description: "마지막 페이지 여부"
          example: false
        hasNext:
          type: "boolean"
          description: "다음 페이지 존재 여부"
          example: true

    DeleteResult:
      type: "object"
      properties:
        id:
          type: "string"
          format: "uuid"
          description: "삭제된 리소스의 ID"
          example: "550e8400-e29b-41d4-a716-446655440000"
        isSoftDeleted:
          type: "boolean"
          description: "논리적 삭제 여부"
          example: true
        isHardDeleted:
          type: "boolean"
          description: "물리적 삭제 여부"
          example: false
        message:
          type: "string"
          description: "삭제 결과 메시지"
          example: "성공적으로 보관(Soft Delete)되었습니다."

    ErrorResponse:
      type: "object"
      properties:
        errorCode:
          type: "string"
          description: "에러 코드"
          example: "INVALID_REQUEST"
        errorMessage:
          type: "string"
          description: "에러 메시지"
          example: "잘못된 요청입니다."
        errorDetails:
          type: "object"
          nullable: true
          description: "상세 에러 내용"
          example: { "field": "email", "reason": "format invalid" }

    DeviceType:
      type: "object"
      properties:
        code:
          type: "string"
          example: "READER"
        label:
          type: "string"
          example: "카드리더기"

    # --- Device Core Schemas ---
    DeviceRequest:
      type: "object"
      required: ["name", "deviceType", "supportedAuthenticationMethods"]
      properties:
        name:
          type: "string"
          description: "장비명"
          example: "1층 로비 카드/PIN 리더기"
        description:
          type: "string"
          description: "장비 설명"
          example: "메인 출입구 우측 설치, 카드 및 비밀번호 겸용"
        deviceCode:
          type: "string"
          description: "장비 관리 코드 (관리번호)"
          example: "DEV-RDR-001"
        deviceType:
          type: "string"
          description: "장비 타입"
          enum: ["ACU", "READER", "CONTROLLER", "CAMERA", "SENSOR"]
          example: "READER"
        parentDeviceId:
          type: "string"
          format: "uuid"
          nullable: true
          description: "상위 장비 ID (예: 리더기가 연결된 ACU)"
          example: "550e8400-e29b-41d4-a716-446655440099"
        # 위치 정보 (Logical Reference)
        siteId:
          type: "string"
          format: "uuid"
          nullable: true
          description: "설치 사이트 ID"
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
        facilityId:
          type: "string"
          format: "uuid"
          nullable: true
          description: "설치 시설물 ID"
          example: "b2c3d4e5-f6a7-8901-2345-678901bcdefa"
        sectorId:
          type: "string"
          format: "uuid"
          nullable: true
          description: "설치 구획(층, 섹션) ID"
          example: "c3d4e5f6-a7b8-9012-3456-789012cdefab"
        areaId:
          type: "string"
          format: "uuid"
          nullable: true
          description: "설치 구역 ID"
          example: "d4e5f6a7-b8c9-0123-4567-890123defabc"
        # 네트워크 및 하드웨어 정보
        ipAddress:
          type: "string"
          description: "IP 주소"
          example: "192.168.1.100"
        macAddress:
          type: "string"
          description: "MAC 주소"
          example: "00:1A:2B:3C:4D:5E"
        port:
          type: "integer"
          description: "통신 포트"
          example: 443
        serialNumber:
          type: "string"
          description: "시리얼 번호"
          example: "SN-20240101-001"
        modelName:
          type: "string"
          description: "모델명"
          example: "XPASS-2"
        firmwareVersion:
          type: "string"
          description: "펌웨어 버전"
          example: "v1.2.3"
        # 장비 능력 (Capability)
        supportedAuthenticationMethods:
          type: "array"
          description: |
            [리더기 전용] 이 장비가 지원하는 인증 방식 목록.<br>
            이 값은 Space Service에서 인증 모드를 설정할 때 기준 데이터로 사용됩니다.
          items:
            type: "string"
            enum: ["CARD", "PIN", "BIOMETRIC", "MOBILE", "QR", "FACE"]
          example: ["CARD", "PIN"]
        config:
          type: "object"
          description: "기타 하드웨어 설정값 (JSON)"
          example: { "baudRate": 9600, "ledColor": "BLUE" }

    Device:
      type: "object"
      properties:
        id:
          type: "string"
          format: "uuid"
          description: "장비 ID"
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: "string"
          description: "장비명"
          example: "1층 로비 카드/PIN 리더기"
        description:
          type: "string"
          description: "장비 설명"
          example: "메인 출입구 우측 설치, 카드 및 비밀번호 겸용"
        deviceCode:
          type: "string"
          description: "장비 코드"
          example: "DEV-RDR-001"
        deviceType:
          type: "string"
          description: "장비 타입"
          example: "READER"
        parentDeviceId:
          type: "string"
          format: "uuid"
          nullable: true
          description: "상위 장비 ID"
          example: "550e8400-e29b-41d4-a716-446655440099"
        # 위치 정보
        siteId:
          type: "string"
          format: "uuid"
          nullable: true
          example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
        facilityId:
          type: "string"
          format: "uuid"
          nullable: true
          example: "b2c3d4e5-f6a7-8901-2345-678901bcdefa"
        sectorId:
          type: "string"
          format: "uuid"
          nullable: true
          example: "c3d4e5f6-a7b8-9012-3456-789012cdefab"
        areaId:
          type: "string"
          format: "uuid"
          nullable: true
          example: "d4e5f6a7-b8c9-0123-4567-890123defabc"
        # 네트워크 정보
        ipAddress:
          type: "string"
          example: "192.168.1.100"
        macAddress:
          type: "string"
          example: "00:1A:2B:3C:4D:5E"
        port:
          type: "integer"
          example: 443
        serialNumber:
          type: "string"
          example: "SN-20240101-001"
        modelName:
          type: "string"
          example: "XPASS-2"
        firmwareVersion:
          type: "string"
          example: "v1.2.3"
        isConnected: 
          type: "boolean"
          description: "현재 장비 연결 상태 (실시간)"
          example: true
        # 장비 능력
        supportedAuthenticationMethods:
          type: "array"
          items:
            type: "string"
          example: ["CARD", "PIN"]
        # 사용 가능한 인증 조합 (프론트엔드 편의용)
        availableAuthModes:
          type: "array"
          description: "supportedAuthenticationMethods를 기반으로 생성된 선택 가능한 인증 모드 목록"
          items:
            type: "object"
            properties:
              code:
                type: "string"
              label:
                type: "string"
          example:
            - code: "CARD_ONLY"
              label: "카드"
            - code: "PIN_ONLY"
              label: "비밀번호"
            - code: "CARD_AND_PIN"
              label: "카드 + 비밀번호"
            - code: "CARD_OR_PIN"
              label: "카드 또는 비밀번호"
        config:
          type: "object"
          example: { "baudRate": 9600, "ledColor": "BLUE" }
        isActive:
          type: "boolean"
          description: "활성 여부"
          example: true
        createdAt:
          type: "string"
          format: "date-time"
          example: "2023-10-01T12:00:00Z"
        updatedAt:
          type: "string"
          format: "date-time"
          example: "2023-10-02T15:30:00Z"

    # --- Firmware Schemas ---
    FirmwareRequest:
      type: "object"
      required: ["name", "deviceModel", "version", "fileUrl", "checksum"]
      properties:
        name:
          type: "string"
          description: "펌웨어명"
          example: "ACU-1000 v2.0.1 Update"
        description:
          type: "string"
          description: "펌웨어 설명"
          example: "보안 패치 및 성능 개선"
        deviceModel:
          type: "string"
          description: "적용 장비 모델명"
          example: "ACU-1000"
        hardwareRevision:
          type: "string"
          description: "하드웨어 리비전"
          default: "1.0"
          example: "1.0"
        version:
          type: "string"
          description: "펌웨어 버전"
          example: "2.0.1"
        fileUrl:
          type: "string"
          format: "uri"
          description: "펌웨어 바이너리 파일 다운로드 URL (S3 등)"
          example: "https://firmware-repo.example.com/acu-1000/v2.0.1.bin"
        checksum:
          type: "string"
          description: "파일 무결성 검증을 위한 SHA-256 Checksum"
          example: "a1b2c3d4e5f678901234567890abcdef1234567890abcdef1234567890abcdef"
        releaseDate:
          type: "string"
          format: "date"
          description: "배포일"
          example: "2024-01-01"

    Firmware:
      type: "object"
      properties:
        id:
          type: "string"
          format: "uuid"
          description: "펌웨어 ID"
          example: "770e8400-e29b-41d4-a716-446655440077"
        tenantId:
          type: "string"
          format: "uuid"
          nullable: true
          description: "소속 테넌트 ID (NULL이면 시스템 전역 펌웨어)"
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: "string"
          description: "펌웨어명"
          example: "ACU-1000 v2.0.1 Update"
        description:
          type: "string"
          description: "펌웨어 설명"
          example: "보안 패치 및 성능 개선"
        deviceModel:
          type: "string"
          description: "적용 장비 모델명"
          example: "ACU-1000"
        hardwareRevision:
          type: "string"
          description: "하드웨어 리비전"
          example: "1.0"
        version:
          type: "string"
          description: "펌웨어 버전"
          example: "2.0.1"
        fileUrl:
          type: "string"
          format: "uri"
          description: "펌웨어 바이너리 파일 다운로드 URL"
          example: "https://firmware-repo.example.com/acu-1000/v2.0.1.bin"
        checksum:
          type: "string"
          description: "SHA-256 Checksum"
          example: "a1b2c3d4e5f678901234567890abcdef1234567890abcdef1234567890abcdef"
        releaseDate:
          type: "string"
          format: "date"
          description: "배포일"
          example: "2024-01-01"
        createdAt:
          type: "string"
          format: "date-time"
          example: "2024-01-01T10:00:00Z"
        updatedAt:
          type: "string"
          format: "date-time"
          example: "2024-01-01T10:00:00Z"

security:
  - bearerAuth: []

paths:
  # ==========================================
  # 1. Device Management
  # ==========================================
  /devices:
    get:
      tags: ["1. Device Management"]
      summary: "장비 목록 조회"
      description: |
        등록된 장비 목록을 조회합니다.<br>
        설치 위치, 연결 정보, 하드웨어 속성 등 다양한 조건으로 필터링할 수 있습니다.<br>
        **Note:** `tenantId`는 인증 토큰(JWT)에서 자동으로 추출합니다.
      parameters:
        # [Location Filters]
        - name: "siteId"
          in: "query"
          description: "설치 사이트 ID 필터"
          schema: 
            type: "string" 
            format: "uuid"
            example: "a1b2c3d4-e5f6-7890-1234-567890abcdef"
        - name: "facilityId"
          in: "query"
          description: "설치 시설물 ID 필터"
          schema: 
            type: "string" 
            format: "uuid"
            example: "b2c3d4e5-f6a7-8901-2345-678901bcdefa"
        - name: "sectorId"
          in: "query"
          description: "설치 구획(층, 섹션) ID 필터"
          schema: 
            type: "string" 
            format: "uuid"
            example: "c3d4e5f6-a7b8-9012-3456-789012cdefab"
        - name: "areaId"
          in: "query"
          description: "설치 구역 ID 필터"
          schema: 
            type: "string" 
            format: "uuid"
            example: "d4e5f6a7-b8c9-0123-4567-890123defabc"
        - name: "accessPointId"
          in: "query"
          description: "연결된 출입 포인트 ID 필터"
          schema: 
            type: "string" 
            format: "uuid"
            example: "e5f6a7b8-c9d0-1234-5678-901234efabcd"
        - name: "parentDeviceId"
          in: "query"
          description: "상위 장비(ACU 등) ID 필터"
          schema: 
            type: "string" 
            format: "uuid"
            example: "550e8400-e29b-41d4-a716-446655440099"
        
        # [Basic Info Filters]
        - name: "name"
          in: "query"
          description: "장비명 검색 (부분 일치)"
          schema: 
            type: "string"
            example: "리더기"
        - name: "description"
          in: "query"
          description: "장비 설명 검색 (부분 일치)"
          schema: 
            type: "string"
            example: "출입구"
        - name: "code"
          in: "query"
          description: "장비 코드 검색 (일치)"
          schema: 
            type: "string"
            example: "DEV-RDR-001"
        - name: "type"
          in: "query"
          description: "장비 타입 필터"
          schema:
            type: "string"
            enum: ["ACU", "READER", "CONTROLLER", "CAMERA", "SENSOR"]
            example: "READER"
        
        # [Hardware & Network Filters]
        - name: "ipAddress"
          in: "query"
          description: "IP 주소 검색"
          schema: 
            type: "string"
            example: "192.168.1.100"
        - name: "macAddress"
          in: "query"
          description: "MAC 주소 검색"
          schema: 
            type: "string"
            example: "00:1A:2B:3C:4D:5E"
        - name: "port"
          in: "query"
          description: "통신 포트 검색"
          schema: 
            type: "integer"
            example: 443
        - name: "serialNumber"
          in: "query"
          description: "시리얼 번호 검색"
          schema: 
            type: "string"
            example: "SN-20240101-001"
        - name: "modelName"
          in: "query"
          description: "모델명 검색"
          schema: 
            type: "string"
            example: "XPASS-2"
        - name: "firmwareVersion"
          in: "query"
          description: "펌웨어 버전 검색"
          schema: 
            type: "string"
            example: "v1.2.3"
        
        # [Capability Filter]
        - name: "capability"
          in: "query"
          description: "지원 인증 방식 필터 (다중 선택 가능, OR 조건)"
          schema:
            type: "array"
            items:
              type: "string"
              enum: ["CARD", "PIN", "BIOMETRIC", "MOBILE", "QR", "FACE"]
            example: ["CARD", "PIN"]

        # [Pagination]
        - name: "page"
          in: "query"
          schema: 
            type: "integer" 
            default: 0
            example: 0
        - name: "size"
          in: "query"
          schema: 
            type: "integer" 
            default: 20
            example: 20
        - name: "sort"
          in: "query"
          description: "정렬 (예: name,asc)"
          schema:
            type: "array"
            items: 
              type: "string"
            example: ["createdAt,desc"]
      responses:
        '200':
          description: "성공"
          content:
            application/json:
              schema:
                type: "object"
                properties:
                  content:
                    type: "array"
                    items: { $ref: "#/components/schemas/Device" }
                  page: { $ref: "#/components/schemas/PageMetadata" }

    post:
      tags: ["1. Device Management"]
      summary: "장비 등록"
      description: |
        새로운 장비를 등록합니다.<br>
        리더기(`READER`)의 경우 `supportedAuthenticationMethods`를 통해 지원하는 인증 방식(Capability)을 정의해야 합니다.
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DeviceRequest" }
      responses:
        '200':
          description: "생성됨"
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Device" }
        '409':
          description: "중복된 데이터 (MAC 주소, 시리얼 번호 등)"
          $ref: "#/components/responses/Conflict"

  /devices/types:
    get:
      tags: ["1. Device Management"]
      summary: "장비 타입 목록 조회"
      description: "UI 드롭다운 구성을 위한 Enum 목록 (ACU, READER 등)"
      responses:
        '200':
          description: "성공"
          content:
            application/json:
              schema:
                type: "array"
                items: { $ref: "#/components/schemas/DeviceType" }

  /devices/{id}:
    get:
      tags: ["1. Device Management"]
      summary: "장비 단건 조회"
      parameters:
        - name: "id"
          in: "path"
          required: true
          schema: 
            type: "string" 
            format: "uuid"
            example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: "성공"
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Device" }
        '404':
          $ref: "#/components/responses/NotFound"

    put:
      tags: ["1. Device Management"]
      summary: "장비 정보 수정"
      parameters:
        - name: "id"
          in: "path"
          required: true
          schema: 
            type: "string" 
            format: "uuid"
            example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DeviceRequest" }
      responses:
        '200':
          description: "수정됨"
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Device" }
        '404':
          $ref: "#/components/responses/NotFound"

    delete:
      tags: ["1. Device Management"]
      summary: "장비 삭제"
      description: |
        장비를 삭제합니다.<br>
        **삭제 정책:**
        - 활성 상태로 출입문에 연결되어 있으면 `409 Conflict` (삭제 불가)
        - 로그 등 참조가 있으면 `Soft Delete` (isSoftDeleted: true)
        - 참조가 없으면 `Hard Delete` (isHardDeleted: true)
      parameters:
        - name: "id"
          in: "path"
          required: true
          schema: 
            type: "string" 
            format: "uuid"
            example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: "삭제 성공"
          content:
            application/json:
              schema: { $ref: "#/components/schemas/DeleteResult" }
        '409':
          description: "삭제 불가 (사용 중인 장비)"
          $ref: "#/components/responses/Conflict"

  # ==========================================
  # 2. Firmware Management
  # ==========================================
  /firmwares:
    get:
      tags: ["2. Firmware Management"]
      summary: "펌웨어 목록 조회"
      description: |
        펌웨어 목록을 조회합니다.<br>
        `deviceModel`, `version` 등으로 필터링할 수 있습니다.
      parameters:
        - name: "name"
          in: "query"
          description: "펌웨어명 검색 (부분 일치)"
          schema:
            type: "string"
            example: "ACU Update"
        - name: "description"
          in: "query"
          description: "펌웨어 설명 검색 (부분 일치)"
          schema:
            type: "string"
            example: "보안 패치"
        - name: "deviceModel"
          in: "query"
          description: "적용 장비 모델명 검색"
          schema:
            type: "string"
            example: "ACU-1000"
        - name: "hardwareRevision"
          in: "query"
          description: "하드웨어 리비전 검색"
          schema:
            type: "string"
            example: "1.0"
        - name: "version"
          in: "query"
          description: "펌웨어 버전 검색"
          schema:
            type: "string"
            example: "2.0.1"
        - name: "releaseDate"
          in: "query"
          description: "배포일 검색 (YYYY-MM-DD)"
          schema:
            type: "string"
            format: "date"
            example: "2024-01-01"
        - name: "page"
          in: "query"
          schema:
            type: "integer"
            default: 0
            example: 0
        - name: "size"
          in: "query"
          schema:
            type: "integer"
            default: 20
            example: 20
        - name: "sort"
          in: "query"
          description: "정렬 (예: version,desc)"
          schema:
            type: "array"
            items:
              type: "string"
            example: ["releaseDate,desc"]
      responses:
        '200':
          description: "성공"
          content:
            application/json:
              schema:
                type: "object"
                properties:
                  content:
                    type: "array"
                    items: { $ref: "#/components/schemas/Firmware" }
                  page: { $ref: "#/components/schemas/PageMetadata" }

    post:
      tags: ["2. Firmware Management"]
      summary: "펌웨어 등록"
      description: |
        새로운 펌웨어를 등록합니다.<br>
        바이너리 파일은 별도 스토리지(S3 등)에 업로드하고, 여기서는 해당 파일의 URL(`fileUrl`)과 메타데이터를 등록합니다.
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/FirmwareRequest" }
      responses:
        '200':
          description: "생성됨"
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Firmware" }
        '409':
          description: "중복된 펌웨어 (모델명 + 버전 조합)"
          $ref: "#/components/responses/Conflict"

  /firmwares/{id}:
    get:
      tags: ["2. Firmware Management"]
      summary: "펌웨어 단건 조회"
      parameters:
        - name: "id"
          in: "path"
          required: true
          schema:
            type: "string"
            format: "uuid"
            example: "770e8400-e29b-41d4-a716-446655440077"
      responses:
        '200':
          description: "성공"
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Firmware" }
        '404':
          $ref: "#/components/responses/NotFound"

    put:
      tags: ["2. Firmware Management"]
      summary: "펌웨어 정보 수정"
      parameters:
        - name: "id"
          in: "path"
          required: true
          schema:
            type: "string"
            format: "uuid"
            example: "770e8400-e29b-41d4-a716-446655440077"
      requestBody:
        content:
          application/json:
            schema: { $ref: "#/components/schemas/FirmwareRequest" }
      responses:
        '200':
          description: "수정됨"
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Firmware" }
        '404':
          $ref: "#/components/responses/NotFound"

    delete:
      tags: ["2. Firmware Management"]
      summary: "펌웨어 삭제"
      parameters:
        - name: "id"
          in: "path"
          required: true
          schema:
            type: "string"
            format: "uuid"
            example: "770e8400-e29b-41d4-a716-446655440077"
      responses:
        '200':
          description: "삭제 성공"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResult"
              example:
                id: "770e8400-e29b-41d4-a716-446655440077"
                isSoftDeleted: false
                isHardDeleted: true
                message: "펌웨어 파일이 영구 삭제되었습니다."
        '404':
          $ref: "#/components/responses/NotFound"